<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stress Test - LoanPulse AI</title>
    <link rel="stylesheet" href="style_3d.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .slider-container {
            margin-bottom: 2rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        input[type=range] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>

<body>

    <!-- ========================= -->
    <!--  HIDDEN PRINT REPORT UI   -->
    <!-- ========================= -->
    <div id="printable-report">
        <div class="report-header">
            <h1 class="report-title">LoanPulse AI</h1>
            <div class="report-meta">Stress Test Analysis Report</div>
            <div class="report-meta">Generated: <span id="print-date"></span></div>
        </div>

        <h2 style="font-size: 16pt; margin-bottom: 20px;">Stress Scenario: <span class="risk-high">Negative
                Outlook</span></h2>

        <!-- Hidden Canvas for Mirroring (Explicit px dims for print) -->
        <div style="width: 100%; margin: 0 auto 30px auto; text-align: center;">
            <img id="print-chart-img" style="max-width: 100%; height: auto; border: 1px solid #ddd;" src=""
                alt="Stress Impact Chart">
        </div>

        <div class="section-title">Simulation Parameters</div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Shock Factor</th>
                    <th>Value</th>
                    <th>Impact Severity</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Revenue Decline</td>
                    <td id="print-revenue">15%</td>
                    <td class="risk-high">High</td>
                </tr>
                <tr>
                    <td>Interest Rate Hike</td>
                    <td id="print-interest">1.0%</td>
                    <td class="risk-safe">Moderate</td>
                </tr>
            </tbody>
        </table>

        <div class="section-title">AI Assessment</div>
        <div class="summary-box" id="print-ai-summary">
            The applied stress test indicates a significant deterioration in Debt Service Coverage Ratio (DSCR).
            Under these conditions, the borrower is likely to breach the 1.25x covenant threshold by Q3.
            Immediate equity injection or debt restructuring provides the only viable mitigation strategy.
        </div>
    </div>
    <!-- ========================= -->
    <!--     END PRINT REPORT      -->
    <!-- ========================= -->

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fa-solid fa-layer-group"></i> LoanPulse AI
        </div>
        <div class="nav-menu">
            <a href="home.html" class="nav-link">Home</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="analysis.html" class="nav-link">Analysis & Chat</a>
            <a href="stress.html" class="nav-link active">Stress Test</a>
        </div>

        <!-- User Menu Container -->
        <div id="user-menu-container" style="position: relative;">
            <div style="display: flex; gap: 0.8rem; align-items: center; cursor: pointer;" id="user-avatar-wrapper">
                <img id="user-avatar" src="" alt="User"
                    style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent-primary); transition: transform 0.2s;">
            </div>

            <!-- Dropdown -->
            <div id="user-dropdown" class="card-3d hidden"
                style="position: absolute; right: 0; top: 50px; width: 200px; padding: 0.5rem; z-index: 1000; background: var(--bg-dark);">
                <div
                    style="padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Signed in as</div>
                    <div id="dropdown-username" style="font-weight: 600; color: white;">User</div>
                </div>
                <div onclick="Auth.logout()"
                    style="padding: 0.8rem 1rem; color: #ef4444; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </div>
            </div>
        </div>
    </nav>

    <div class="container">

        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
            <div>
                <h2 style="font-size: 2rem; margin: 0;">Loan Stress Analysis</h2>
                <p style="color: var(--text-muted);">Project-specific economic shock simulation.</p>
            </div>

            <button onclick="window.print()" class="btn-3d btn-primary" style="background: white; color: #0f172a;">
                <i class="fa-solid fa-file-pdf"></i> Download PDF
            </button>
        </div>

        <div class="grid-2 scene-3d">

            <!-- Controls -->
            <div class="card-3d" style="padding: 2rem;">
                <h3><i class="fa-solid fa-sliders"></i> Simulation Parameters</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Use sample data or adjust
                    sliders.</p>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Revenue Drop (Sample Data: 15%)</span>
                        <span id="val-revenue">15%</span>
                    </div>
                    <input type="range" min="0" max="50" value="15" step="5"
                        oninput="updateVal('revenue', this.value, '%'); updateChartRealtime()">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Interest Rate Hike</span>
                        <span id="val-interest">1.0%</span>
                    </div>
                    <input type="range" min="0" max="5" value="1.0" step="0.5"
                        oninput="updateVal('interest', this.value, '%'); updateChartRealtime()">
                </div>

                <button onclick="runStressTest()" class="btn-3d btn-primary" style="width: 100%; margin-top: 1rem;">
                    <i class="fa-solid fa-microchip"></i> Run AI Prediction
                </button>
            </div>

            <!-- Visuals -->
            <div class="card-3d" style="padding: 2rem; display: flex; flex-direction: column;">
                <h3>Impact Visualization</h3>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; position: relative;">
                    <canvas id="stressChart"></canvas>
                    <div id="chart-overlay" style="position: absolute; text-align: center; color: var(--text-muted);">
                        <i class="fa-solid fa-chart-area"
                            style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Adjust parameters and run analysis</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Output -->
        <div class="card-3d scene-3d" style="margin-top: 2rem; padding: 2rem; min-height: 200px;">
            <div class="chat-header"
                style="margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                <h3><i class="fa-solid fa-wand-magic-sparkles" style="color: var(--accent-glow);"></i> AI Impact
                    Assessment</h3>
            </div>
            <div id="ai-stress-output" style="line-height: 1.6; color: var(--text-main);">
                <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
                    Results will appear here...
                </div>
            </div>
        </div>

    </div>

    <script src="env.js"></script>
    <script src="app.js"></script>
    <script>
        document.getElementById('print-date').innerText = new Date().toLocaleString();

        // Local Logic for Stress Page
        let stressChart = null;
        let printStressChart = null;

        function updateVal(id, val, suffix) {
            document.getElementById(`val-${id}`).innerText = (val > 0 && id === 'market' ? '+' : '') + val + suffix;
        }

        // Shared Config
        const chartConfig = (data1, data2, isPrint = false) => ({
            type: 'line',
            data: {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                datasets: [
                    {
                        label: 'Baseline DSCR',
                        data: data1 || [1.5, 1.55, 1.6, 1.65],
                        borderColor: isPrint ? '#16a34a' : '#4ade80', // Darker green for print
                        borderWidth: isPrint ? 3 : 2,
                        tension: 0.4
                    },
                    {
                        label: 'Stressed DSCR',
                        data: data2 || [1.5, 1.4, 1.2, 1.05],
                        borderColor: isPrint ? '#dc2626' : '#ef4444', // Darker red for print
                        borderDash: [5, 5],
                        borderWidth: isPrint ? 3 : 2,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Important for fitting fixed box
                plugins: { legend: { labels: { color: isPrint ? '#333' : 'white' } } },
                scales: {
                    y: {
                        grid: { color: isPrint ? '#eee' : 'rgba(255,255,255,0.1)' },
                        ticks: { color: isPrint ? '#333' : 'white' },
                        title: { display: true, text: 'DSCR', color: isPrint ? '#666' : '#94a3b8' }
                    },
                    x: { ticks: { color: isPrint ? '#333' : 'white' } }
                }
            }
        });

        async function initStressChart(data1, data2) {
            // 1. Main Chart (Dark Mode for UI)
            const ctx = document.getElementById('stressChart').getContext('2d');
            const overlay = document.getElementById('chart-overlay');
            if (overlay) overlay.style.display = 'none';

            if (stressChart) stressChart.destroy();
            stressChart = new Chart(ctx, chartConfig(data1, data2, false));

            // 2. Print Chart (Light Mode for PDF - "Ghost Render")
            // Create a temp canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 800;
            tempCanvas.height = 400;
            // We don't append it to body, just render in memory/detached state if possible, 
            // but Chart.js usually needs it attached or at least context. 
            // Safer to append hidden.
            tempCanvas.style.visibility = 'hidden';
            tempCanvas.style.position = 'absolute';
            document.body.appendChild(tempCanvas);

            const printCtx = tempCanvas.getContext('2d');
            const printChart = new Chart(printCtx, chartConfig(data1, data2, true));

            // Wait for render cycle
            setTimeout(() => {
                const printImg = document.getElementById('print-chart-img');
                if (printImg) {
                    printImg.src = printChart.toBase64Image();
                }
                printChart.destroy();
                document.body.removeChild(tempCanvas);
            }, 800);
        }

        // Real-time chart update when sliders change
        function updateChartRealtime() {
            const revenueDrop = parseFloat(document.getElementById('val-revenue').innerText) || 0;
            const interestHike = parseFloat(document.getElementById('val-interest').innerText) || 0;

            // Calculate stressed values
            const baseline = [1.5, 1.6, 1.7, 1.8];
            const dropAmount = revenueDrop / 100;
            const stressed = baseline.map(v => parseFloat((v * (1 - dropAmount) - (interestHike / 10)).toFixed(2)));

            // Update or create chart
            initStressChart(baseline, stressed);

            // Update AI Impact Assessment in real-time
            updateAIAssessment(revenueDrop, interestHike, stressed);
        }

        // Generate dynamic AI assessment based on current values
        function updateAIAssessment(revenueDrop, interestHike, stressedValues) {
            const outputDiv = document.getElementById('ai-stress-output');
            const finalDSCR = stressedValues[stressedValues.length - 1];

            let severity = 'Low';
            let severityColor = '#4ade80';
            let recommendation = 'The loan remains healthy under these conditions.';

            if (finalDSCR < 1.0) {
                severity = 'Critical';
                severityColor = '#ef4444';
                recommendation = 'Immediate action required: Consider debt restructuring or equity injection.';
            } else if (finalDSCR < 1.25) {
                severity = 'High';
                severityColor = '#f59e0b';
                recommendation = 'Covenant breach likely. Recommend requesting waiver or implementing mitigation plan.';
            } else if (finalDSCR < 1.5) {
                severity = 'Moderate';
                severityColor = '#facc15';
                recommendation = 'Monitor closely. Consider proactive discussions with lender.';
            }

            const assessment = `
                <div style="padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px; border-left: 4px solid ${severityColor};">
                    <h4 style="margin: 0 0 1rem 0; color: ${severityColor};">
                        <i class="fa-solid fa-triangle-exclamation"></i> Stress Test Results
                    </h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Impact Analysis:</strong> Under a revenue drop scenario of <strong>${revenueDrop}%</strong> 
                        and interest rate hike of <strong>${interestHike}%</strong>, the Debt Service Coverage Ratio (DSCR) 
                        risks falling to <strong style="color: ${severityColor};">${finalDSCR}x</strong> by Q4.
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <strong>Risk Severity:</strong> <span style="color: ${severityColor}; font-weight: 600;">${severity}</span>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <strong>Key Risks:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            ${finalDSCR < 1.25 ? '<li>Leverage Ratio may breach covenant threshold</li>' : ''}
                            ${finalDSCR < 1.5 ? '<li>Liquidity covenants will be tested</li>' : ''}
                            ${revenueDrop > 20 ? '<li>Significant revenue pressure detected</li>' : ''}
                            ${interestHike > 2 ? '<li>Interest rate sensitivity is high</li>' : ''}
                            ${finalDSCR >= 1.5 ? '<li>All covenants remain within acceptable range</li>' : ''}
                        </ul>
                    </div>

                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                        <strong>Recommendation:</strong> ${recommendation}
                    </div>

                    <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); font-style: italic;">
                        <i class="fa-solid fa-info-circle"></i> Click "Run AI Prediction" for detailed AI-powered analysis
                    </div>
                </div>
            `;

            outputDiv.innerHTML = assessment;
        }

        async function runStressTest() {
            const revenueDrop = document.getElementById('val-revenue').innerText;
            const interestHike = document.getElementById('val-interest').innerText;

            // Populating Print Data
            document.getElementById('print-revenue').innerText = revenueDrop;
            document.getElementById('print-interest').innerText = interestHike;

            const btn = document.querySelector('button[onclick="runStressTest()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing...';

            // 1. Chart Update (Sample Data Math)
            const baseline = [1.5, 1.6, 1.7, 1.8];
            const dropAmount = parseFloat(revenueDrop) / 100;
            const stressed = baseline.map(v => (v * (1 - dropAmount) - (parseFloat(interestHike) / 10)).toFixed(2));

            initStressChart(baseline, stressed);

            // 2. Call Gemini (Or Mock)
            const prompt = `
                Perform a stress test analysis for a corporate loan project.
                Scenario: Revenue Drop of ${revenueDrop}, Interest Rate Hike of ${interestHike}.
                
                Explain the potential impact on Debt Service Coverage Ratio (DSCR).
            `;

            const outputDiv = document.getElementById('ai-stress-output');
            outputDiv.innerHTML = '<p class="blink" style="text-align:center">Generating insights...</p>';

            // Pass true for isStressTest to get correct mock
            const result = await callGeminiAPI(prompt, true);
            outputDiv.innerHTML = result;

            // Mirror to Print
            document.getElementById('print-ai-summary').innerHTML = result;

            // 3. Save to History
            History.add(`Stress Test (${revenueDrop} Rev)`, 'Stress Test', {
                revenueDrop,
                interestHike,
                timestamp: new Date().toISOString()
            });

            btn.innerHTML = originalText;
        }
    </script>
</body>

</html>