<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis - LoanPulse AI</title>
    <link rel="stylesheet" href="style_3d.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fa-solid fa-layer-group"></i> LoanPulse AI
        </div>
        <div class="nav-menu">
            <a href="home.html" class="nav-link">Home</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="analysis.html" class="nav-link active">Analysis & Chat</a>
            <a href="stress.html" class="nav-link">Stress Test</a>
        </div>

        <!-- User Menu Container -->
        <div id="user-menu-container" style="position: relative;">
            <div style="display: flex; gap: 0.8rem; align-items: center; cursor: pointer;" id="user-avatar-wrapper">
                <img id="user-avatar" src="" alt="User"
                    style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent-primary); transition: transform 0.2s;">
            </div>

            <!-- Dropdown -->
            <div id="user-dropdown" class="card-3d hidden"
                style="position: absolute; right: 0; top: 50px; width: 200px; padding: 0.5rem; z-index: 1000; background: var(--bg-dark);">
                <div
                    style="padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Signed in as</div>
                    <div id="dropdown-username" style="font-weight: 600; color: white;">User</div>
                </div>
                <div onclick="Auth.logout()"
                    style="padding: 0.8rem 1rem; color: #ef4444; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
            <div>
                <h2 style="font-size: 2rem; margin: 0;">Analysis Engine</h2>
                <p style="color: var(--text-muted);">Project: <span style="color:white">Global Shipping Revamp</span>
                </p>
            </div>

            <!-- REMOVED PDF BUTTON AS REQUESTED -->
        </div>

        <div class="grid-2 scene-3d">

            <!-- Left: Document & Controls -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">

                <!-- Upload Card -->
                <div class="card-3d" style="padding: 2rem; border: 1px dashed rgba(255,255,255,0.3);">
                    <h3><i class="fa-solid fa-file-pdf"></i> Load Project Document</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem;">Upload a credit agreement.</p>
                    <input type="file" id="file-input" style="display: none;" accept="application/pdf">
                    <button onclick="document.getElementById('file-input').click()" class="btn-3d"
                        style="background: rgba(255,255,255,0.1); color: white; width: 100%;">
                        Select PDF
                    </button>
                    <div id="file-name" style="margin-top:0.5rem; font-size: 0.8rem; color: #4ade80;"></div>
                </div>

                <!-- Analysis Controls -->
                <div class="card-3d" style="padding: 2rem;">
                    <h3>Run Project Scenario</h3>
                    <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-muted);">EBITDA (Sample: 5M)</label>
                            <input type="number" id="input-ebitda" class="input-field" placeholder="e.g. 5000000"
                                style="width: 100%;" value="5000000">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-muted);">Total Debt (Sample: 15M)</label>
                            <input type="number" id="input-debt" class="input-field" placeholder="e.g. 15000000"
                                style="width: 100%;" value="15000000">
                        </div>
                        <button onclick="triggerAnalysis()" class="btn-3d btn-primary" style="margin-top: 0.5rem;">
                            <i class="fa-solid fa-calculator"></i> Simulate Impact
                        </button>
                    </div>
                </div>

            </div>

            <!-- Right: Gemini Chatbot -->
            <div class="card-3d chat-container">
                <div class="chat-header"
                    style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa-solid fa-sparkles" style="color: var(--accent-glow);"></i> Gemini Assistant
                    </div>
                    <span class="status-dot"
                        style="width: 8px; height: 8px; background: #4ade80; border-radius: 50%;"></span>
                </div>

                <div id="chat-history" class="chat-history">
                    <div class="msg ai">
                        Hello! I am your LoanPulse Assistant. I can help you analyze loan covenants, draft waiver
                        letters, or explain risk scenarios. How can I assist?
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="chat-input" class="input-field"
                        placeholder="Ask about leverage ratios, risk..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()" class="btn-3d btn-primary">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="env.js"></script>
    <script src="app.js"></script>
    <script>
        // Chat Specific Logic
        async function sendMessage(text = null) {
            const input = document.getElementById('chat-input');
            const message = text || input.value.trim();

            if (!message) return;

            // User Msg
            appendMessage(message, 'user');
            if (!text) input.value = '';

            // AI Loading
            const loadingId = appendMessage('<i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...', 'ai');

            try {
                // Call Shared Gemini Function (Handle missing key gracefully inside)
                const response = await callGeminiAPI(message);

                // Remove Loading
                document.getElementById(loadingId).remove();

                // AI Response
                appendMessage(response, 'ai');

                if (!text) {
                    History.add("Chat Analysis", "Analysis", { prompt: message });
                }

            } catch (err) {
                document.getElementById(loadingId).innerHTML = "System Error.";
            }
        }

        function appendMessage(html, type) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.id = 'msg-' + Date.now();
            div.innerHTML = html;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function triggerAnalysis() {
            const ebitda = document.getElementById('input-ebitda').value;
            const debt = document.getElementById('input-debt').value;
            if (!ebitda) {
                alert('Enter EBITDA');
                return;
            }

            const prompt = `Perform a risk analysis for a company with EBITDA ${ebitda} and Debt ${debt}. Calculate Leverage Ratio. Assuming covenant max is 4.0x, is it safe?`;
            sendMessage(prompt);

            // Explicitly save this meaningful analysis
            History.add(`Covenant Check (Debt: ${debt})`, "Analysis", { ebitda, debt });
        }

        // PDF Upload Hook
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                document.getElementById('file-name').innerText = e.target.files[0].name;
                appendMessage(`I have uploaded the document: ${e.target.files[0].name}. Please analyze the Negative Covenants.`, 'user');

                setTimeout(() => {
                    appendMessage("I've analyzed the document. It appears to be a standard LMA credit agreement. Found 3 financial covenants. Ready for queries.", 'ai');
                }, 1500);
            }
        });
    </script>
</body>

</html>