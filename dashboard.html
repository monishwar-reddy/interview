<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LoanPulse AI</title>
    <link rel="stylesheet" href="style_3d.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- Printable Report (Hidden on Screen) -->
    <div id="printable-report">
        <h1 style="text-align: center; margin-bottom: 5px;">Portfolio Analysis Report</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">Generated via LoanPulse AI â€¢ <span
                id="print-date"></span></p>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">Risk Distribution</h3>
        <div style="text-align: center; margin: 20px 0;">
            <img id="print-chart-img" style="max-width: 80%; height: auto; border: 1px solid #eee; padding: 10px;"
                src="" alt="Risk Chart">
        </div>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px;">Covenant Matrix</h3>
        <div id="print-content"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fa-solid fa-layer-group"></i> LoanPulse AI
        </div>
        <div class="nav-menu">
            <a href="home.html" class="nav-link">Home</a>
            <a href="dashboard.html" class="nav-link active">Dashboard</a>
            <a href="analysis.html" class="nav-link">Analysis & Chat</a>
            <a href="stress.html" class="nav-link">Stress Test</a>
        </div>

        <div id="user-menu-container" style="position: relative;">
            <div style="display: flex; gap: 0.8rem; align-items: center; cursor: pointer;" id="user-avatar-wrapper">
                <img id="user-avatar" src="" alt="User"
                    style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent-primary); transition: transform 0.2s;">
            </div>
            <div id="user-dropdown" class="card-3d hidden"
                style="position: absolute; right: 0; top: 50px; width: 200px; padding: 0.5rem; z-index: 1000; background: var(--bg-dark);">
                <div
                    style="padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Signed in as</div>
                    <div id="dropdown-username" style="font-weight: 600; color: white;">User</div>
                </div>
                <div onclick="Auth.logout()"
                    style="padding: 0.8rem 1rem; color: #ef4444; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </div>
            </div>
        </div>
    </nav>

    <div class="container">

        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">Portfolio <span
                        style="color: var(--accent-primary);">Matrix</span></h1>
                <p style="color: var(--text-muted);">Detailed Covenant Analysis & Risk Distribution</p>
            </div>
            <!-- Hidden File Input for Import -->
            <input type="file" id="dashboard-upload" style="display: none;" accept=".pdf"
                onchange="handleDashboardUpload(this)">

            <div style="display: flex; gap: 1rem;">
                <button onclick="document.getElementById('dashboard-upload').click()" class="btn-3d"
                    style="background: rgba(255,255,255,0.1); color: white; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-file-pdf"></i> Import PDF
                </button>
                <button onclick="loadSampleData()" class="btn-3d"
                    style="background: rgba(255,255,255,0.1); color: white;">
                    <i class="fa-solid fa-rotate"></i> New Data
                </button>
                <button onclick="window.print()" class="btn-3d btn-primary" style="background: white; color: #0f172a;">
                    <i class="fa-solid fa-file-pdf"></i> Download Report
                </button>
            </div>
        </div>

        <!-- Detailed Loan Analysis View -->
        <div class="grid-2 scene-3d" style="margin-bottom: 2rem; grid-template-columns: 2fr 1fr;">

            <!-- Left Col: Tables -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">

                <!-- Covenant Compliance Table -->
                <div class="card-3d" style="padding: 0; overflow: hidden;">
                    <div style="padding: 1rem 1.5rem; background: var(--accent-primary); color: white;">
                        <h3 style="margin: 0; font-size: 1.1rem;">Covenant Compliance</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="analysis-matrix" style="margin: 0;">
                            <thead style="background: rgba(59, 130, 246, 0.1);">
                                <tr>
                                    <th style="color: white; border-bottom: none;">Covenant</th>
                                    <th style="color: white; border-bottom: none;">Actual</th>
                                    <th style="color: white; border-bottom: none;">Status</th>
                                    <th style="color: white; border-bottom: none;">Risk</th>
                                </tr>
                            </thead>
                            <tbody id="covenant-body">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="4" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Metrics Table -->
                <div class="card-3d" style="padding: 0; overflow: hidden;">
                    <div
                        style="padding: 1rem 1.5rem; background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <h3 style="margin: 0; font-size: 1.1rem; color: white;">Financial Metrics (Latest Quarter)</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="analysis-matrix" style="margin: 0;">
                            <thead style="background: rgba(30, 41, 59, 0.5);">
                                <tr>
                                    <th style="color: #94a3b8; border-bottom: none;">Metric</th>
                                    <th style="color: #94a3b8; border-bottom: none;">Value</th>
                                </tr>
                            </thead>
                            <tbody id="financial-body">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="2" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Right Col: Charts & History (Moved here for better layout) -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">

                <!-- Risk Distribution Chart (Covenants) -->
                <div class="card-3d" style="padding: 2rem; display: flex; flex-direction: column; height: 320px;">
                    <h3><i class="fa-solid fa-chart-pie"></i> Risk Distribution</h3>
                    <div style="flex: 1; position: relative;">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card-3d" style="padding: 2rem; display: flex; flex-direction: column; height: 300px;">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> History</h3>
                    <div id="history-list" style="margin-top: 1rem; flex: 1; overflow-y: auto;"></div>
                </div>

            </div>
        </div>

        <div style="display: none;">
            <!-- Hide old grid-2 container hooks if any remain in JS selection, but we replaced the HTML structure -->
        </div>

    </div>

    <!-- Mock Data Script -->
    <script src="mock_data.js"></script>
    <script src="env.js"></script>
    <script src="app.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('print-date').innerText = new Date().toLocaleDateString();
            loadSampleData(); // Load initial random data
        });

        // Current Active Loan State (Single Object)
        let ACTIVE_LOAN = null;

        // History State (Local for Dashboard)
        function getDashboardHistory() {
            try { return JSON.parse(localStorage.getItem('dashboard_history')) || []; } catch { return []; }
        }

        function saveHistory(history) {
            localStorage.setItem('dashboard_history', JSON.stringify(history));
            renderHistory();
        }

        function addToHistory(title, type, data) {
            const history = getDashboardHistory();
            const newItem = {
                id: Date.now(),
                title: title,
                type: type,
                data: data, // Save the full loan object
                date: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ", " + new Date().toLocaleDateString()
            };
            // FIFO: Add to top
            history.unshift(newItem);
            // Limit to 5
            if (history.length > 5) history.pop();
            saveHistory(history);
        }

        function deleteHistory(event, id) {
            event.stopPropagation(); // Prevent triggering the click on parent
            let history = getDashboardHistory();
            history = history.filter(item => item.id !== id);
            saveHistory(history);
        }

        function loadHistoryItem(id) {
            const history = getDashboardHistory();
            const item = history.find(i => i.id === id);
            if (item && item.data) {
                ACTIVE_LOAN = item.data;
                const title = document.querySelector('h1 span');
                if (title) title.innerText = ACTIVE_LOAN.borrower;
                renderDashboard(); // Render without adding to history again
            }
        }

        function generateRandomDetailedLoan(nameOverride) {
            const companies = ["TechFlow Systems", "GreenField Agri", "Solaris Energy", "Quantum Logistics", "BlueSky Avg", "Pioneer Works", "Nebula Tech", "Apex Dynamics"];
            const name = nameOverride || companies[Math.floor(Math.random() * companies.length)] + " " + ["Inc", "Ltd", "Corp", "Solutions"].sort(() => 0.5 - Math.random())[0];

            // Financials - Increased variance
            const revenue = Math.floor(Math.random() * 80 + 20) * 1000000;
            const ebitda = revenue * (Math.random() * 0.3 + 0.05); // 5-35% margin
            const debt = ebitda * (Math.random() * 5 + 1); // 1-6x leverage

            // Covenants
            const covenants = [
                { name: "Max Leverage Ratio", threshold: "4.0x", actual: (debt / ebitda).toFixed(2), type: "max", limit: 4.0 },
                { name: "Min Interest Coverage", threshold: "3.0x", actual: (Math.random() * 4 + 1.0).toFixed(1), type: "min", limit: 3.0 },
                { name: "Min Liquidity", threshold: "$1M", actual: Math.floor(Math.random() * 2000 + 200) * 1000, type: "min_val", limit: 1000000 },
                { name: "Debt Service Coverage", threshold: "1.25x", actual: (Math.random() * 1.5 + 0.8).toFixed(2), type: "min", limit: 1.25 }
            ];

            // Assign Status
            covenants.forEach(c => {
                let val = parseFloat(c.actual);
                if (c.type === 'min_val') {
                    if (val < c.limit) { c.status = 'danger'; c.risk = 'High Risk'; }
                    else if (val < c.limit * 1.1) { c.status = 'warning'; c.risk = 'Monitor'; }
                    else { c.status = 'safe'; c.risk = 'Safe'; }
                    c.actualDisplay = "$" + (val).toLocaleString();
                } else {
                    if (c.type === 'max') {
                        if (val > c.limit) { c.status = 'danger'; c.risk = 'High Risk'; }
                        else if (val > c.limit * 0.85) { c.status = 'warning'; c.risk = 'Monitor'; }
                        else { c.status = 'safe'; c.risk = 'Safe'; }
                        c.actualDisplay = val + "x";
                    } else {
                        if (val < c.limit) { c.status = 'danger'; c.risk = 'High Risk'; }
                        else if (val < c.limit * 1.15) { c.status = 'warning'; c.risk = 'Monitor'; }
                        else { c.status = 'safe'; c.risk = 'Safe'; }
                        c.actualDisplay = val + "x";
                    }
                }
            });

            // Ensure mixed status for demo interest
            if (Math.random() > 0.5 && !covenants.some(c => c.status === 'warning')) {
                covenants[Math.floor(Math.random() * covenants.length)].status = 'warning';
            }

            return {
                borrower: name,
                financials: {
                    "Revenue": "$" + (revenue).toLocaleString(),
                    "EBITDA": "$" + (ebitda).toLocaleString(),
                    "Total Debt": "$" + (debt).toLocaleString(),
                    "Interest Exp": "$" + (Math.floor(ebitda / 4)).toLocaleString(),
                    "Cash": "$" + (Math.floor(revenue * 0.05)).toLocaleString()
                },
                covenants: covenants
            };
        }

        function loadSampleData() {
            ACTIVE_LOAN = generateRandomDetailedLoan();

            // Update Title
            const title = document.querySelector('h1 span');
            if (title) title.innerText = ACTIVE_LOAN.borrower;

            // Add to History
            addToHistory(ACTIVE_LOAN.borrower, "Sample Analysis", ACTIVE_LOAN);

            renderDashboard();
        }

        function handleDashboardUpload(input) {
            if (input.files && input.files[0]) {
                const name = input.files[0].name.replace('.pdf', '');
                ACTIVE_LOAN = generateRandomDetailedLoan(name + " (Imported)");

                // Add to History
                addToHistory(ACTIVE_LOAN.borrower, "PDF Import", ACTIVE_LOAN);

                renderDashboard();
                alert(`Analysis loaded for ${name}`);
            }
        }

        function renderDashboard() {
            if (!ACTIVE_LOAN) return;

            // --- 1. Screen Render (Dark Mode) ---
            const covBody = document.getElementById('covenant-body');
            covBody.innerHTML = ACTIVE_LOAN.covenants.map(c => {
                const color = c.status === 'danger' ? '#ef4444' : (c.status === 'warning' ? '#facc15' : '#4ade80');
                const badge = c.status === 'danger' ? 'FAIL' : (c.status === 'warning' ? 'WARN' : 'PASS');
                const riskColor = c.status === 'danger' ? '#ef4444' : (c.status === 'warning' ? '#fbbf24' : '#94a3b8');
                return `
                <tr style="animation: fadeIn 0.3s ease-out;">
                    <td style="color:white; font-weight:500;">${c.name}</td>
                    <td style="color:white;">${c.actualDisplay}</td>
                    <td style="font-weight:700; color:${color};">${badge}</td>
                    <td style="color:${riskColor};">${c.risk}</td>
                </tr>`;
            }).join('');

            const finBody = document.getElementById('financial-body');
            finBody.innerHTML = Object.entries(ACTIVE_LOAN.financials).map(([key, val]) => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); animation: fadeIn 0.3s ease-out;">
                    <td style="font-weight:600; color:white;">${key}</td>
                    <td style="color: var(--text-muted);">${val}</td>
                </tr>
            `).join('');

            updateChart();
            renderHistory();

            // --- 2. Print Render (Light Mode/PDF) ---
            // We explicitly generate clean HTML with black text for the PDF div
            const printContent = document.getElementById('print-content');
            if (printContent) {
                // Generate Covenant Print Table
                const printCovRows = ACTIVE_LOAN.covenants.map(c => {
                    // Use darker, print-safe colors
                    const color = c.status === 'danger' ? '#dc2626' : (c.status === 'warning' ? '#d97706' : '#16a34a');
                    const bg = c.status === 'danger' ? '#fef2f2' : (c.status === 'warning' ? '#fffbeb' : '#f0fdf4');
                    return `
                    <tr style="background:${bg}">
                        <td style="padding:8px; border:1px solid #ccc; color:black;">${c.name}</td>
                        <td style="padding:8px; border:1px solid #ccc; color:black;">${c.actualDisplay}</td>
                        <td style="padding:8px; border:1px solid #ccc; color:${color}; font-weight:bold;">${c.status.toUpperCase()}</td>
                        <td style="padding:8px; border:1px solid #ccc; color:black;">${c.risk}</td>
                    </tr>`;
                }).join('');

                const printFinRows = Object.entries(ACTIVE_LOAN.financials).map(([key, val]) => `
                    <tr>
                        <td style="padding:8px; border:1px solid #ccc; color:black; font-weight:bold;">${key}</td>
                        <td style="padding:8px; border:1px solid #ccc; color:black;">${val}</td>
                    </tr>
                `).join('');

                printContent.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <h4 style="border-bottom: 2px solid #333; margin-bottom: 10px; color:black;">Covenant Compliance</h4>
                        <table style="width:100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="background:#f3f4f6;">
                                <tr>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Covenant</th>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Actual</th>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Status</th>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Risk</th>
                                </tr>
                            </thead>
                            <tbody>${printCovRows}</tbody>
                        </table>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="border-bottom: 2px solid #333; margin-bottom: 10px; color:black;">Financial Metrics</h4>
                        <table style="width:100%; border-collapse: collapse; font-size: 12px;">
                             <thead style="background:#f3f4f6;">
                                <tr>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Metric</th>
                                    <th style="padding:8px; border:1px solid #ccc; text-align:left; color:black;">Value</th>
                                </tr>
                            </thead>
                            <tbody>${printFinRows}</tbody>
                        </table>
                    </div>
                `;
            }
        }

        let riskChartInstance = null;
        function updateChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');

            let safe = 0, warning = 0, danger = 0;
            ACTIVE_LOAN.covenants.forEach(c => {
                if (c.status === 'safe') safe++;
                else if (c.status === 'warning') warning++;
                else danger++;
            });

            const total = safe + warning + danger;

            const config = {
                type: 'doughnut',
                data: {
                    labels: ['Safe', 'Warning', 'Fail'],
                    datasets: [{
                        data: [safe, warning, danger],
                        backgroundColor: ['#4ade80', '#fbbf24', '#ef4444'], // Ensure Yellow is visible
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 10 },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw || 0;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                    return ` ${context.label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'percentageLabels',
                    afterDraw: function (chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            if (!meta.hidden) {
                                meta.data.forEach((element, index) => {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        ctx.font = `bold 12px Inter, sans-serif`;
                                        ctx.fillStyle = index === 2 ? 'white' : 'black';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';

                                        const percentage = Math.round((value / total) * 100) + "%";
                                        const model = element.tooltipPosition();
                                        ctx.fillText(percentage, model.x, model.y);
                                    }
                                });
                            }
                        });
                    }
                }]
            };

            if (riskChartInstance) riskChartInstance.destroy();
            riskChartInstance = new Chart(ctx, config);

            // Print Image Logic
            setTimeout(() => {
                const printImg = document.getElementById('print-chart-img');
                if (printImg) printImg.src = riskChartInstance.toBase64Image();
            }, 800);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = getDashboardHistory();

            if (history.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size:0.9rem;">No recent analysis.</div>';
                return;
            }

            list.innerHTML = history.map(item => `
                <div onclick="loadHistoryItem(${item.id})" style="background: rgba(255,255,255,0.03); padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s;">
                    <style>div[onclick]:hover { background: rgba(255,255,255,0.1) !important; }</style>
                    <div>
                        <div style="font-weight: 600; font-size: 0.85rem; color: white;">${item.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${item.date}</div>
                    </div>
                    <button onclick="deleteHistory(event, ${item.id})" style="background: none; border: none; color: #ef4444; opacity: 0.8; cursor: pointer; padding: 5px;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`).join('');
        }
    </script>
</body>

</html>